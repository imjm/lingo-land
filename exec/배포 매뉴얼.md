# 배포 매뉴얼

## 버전 등 정리

### 프론트엔드

- HTML, CSS, JavaScript(ES6)
- Vue.js
    - **v3.4.31**
    - Pinia
- Node.js
    - 20.15.1
    - [https://nodejs.org/en](https://nodejs.org/en)

### 백엔드

- Java
    - jdk 21
    - Zulu 21.0.3+9
        - [https://www.azul.com/downloads/?package=jdk#zulu](https://www.azul.com/downloads/?package=jdk#zulu)
    
- SpringBoot
    - 3.3.1
- JPA
    - 3.3.1
- SpringSecurity
    - 6.3.1
- JWT, OAuth 2.0, OpenID Connect
- Gradle
    - 8.9

### 통신서버

- OpenVidu (WebRTC - signalling, turn, stun, media 포함)
    - 2.23.0

### DB

- Postgresql 16
    - [https://meeting.ssafy.com/s11p10a6/pl/gj3dp6c5xtbhzkh5b441crfksy](https://meeting.ssafy.com/s11p10a6/pl/gj3dp6c5xtbhzkh5b441crfksy)
- Ollama (Gen AI Server, FaceBook)

https://github.com/ollama/ollama/blob/main/docs/docker.md

https://ollama.com/library/llama3.1

## 배포

환경변수는 yml 파일에 포함되어 있음

docker network 생성 후 여러 스택을 연결해 사용했음.

```json
docker network create backend-network
```

- OpenVidu 배포 매뉴얼
    
    ### **배포에 필요한 조건들**
    
    - 2개의 CPU 8GB 이상의 RAM
    - Docker가 설치됨
    - Docker Compose가 설치됨(최소 1.24 버전)
    - 도메인 이름
    - 포트
        - 22 TCP : SSH를 사용하여 관리자 OpenVidu에 연결
        - 80 TCP : SSL 인증서를 생성하기 위해 Let's Encrypt를 선택하는 경우 사용
        - 443 TCP : OpenVidu 서버 및 애플리케이션은 기본적으로 https 포트로 통신
        - 3478 TCP + UDP : STUN/TURN 서버에서 클라이언트 IP를 확인하는 데 사용
        - 40000- 57000 TCP + UPD : Kurento Media Server에서 미디어 연결을 설정하는 데 사용
        - 57001 - 65535 TCP + UDP : 중계된 미디어 연결을 설정하기 위해 TURN 서버에서 사용
        - 우분투 기준 ufw allow 명령어로 열어줌
    
    ### 배포하기
    
    명령어 순서대로 실행
    
    ```java
    sudo su
    
    cd /opt
    
    curl https://s3-eu-west-1.amazonaws.com/aws.openvidu.io/install_openvidu_latest.sh | bash
    ```
    
    설치 경로로 이동해서 .env 파일 수정
    
    - DOMAIN_OR_PUBLIC_IP에 도메인 이름
    - OPENVIDU_SECRET에 오픈비두 엑세스를 위한 시크릿키
    - CERTIFICATE_TYPE=letsencrypt
    
    이 상태에서 ./openvidu start 명령어를 통해 오픈 비두를 한 번 실행해준다.
    
    이때 반드시 80 포트와 443 포트를 오픈 비두가 사용할 수 있게 해야 한다.
    
    시작에 성공했다면 이제 오픈 비두를 사용할 수 있는 상태이다.
    
    다시 .env파일에서 HTTP 포트와 HTTPS 포트를 내가 정하고 싶은 포트 번호로 부여해주고 해당 포트를 ufw 명령어로 열어주면 된다.
    
    https://도메인:포트번호 → 우리의 배포 openvidu에 접근할 수 있는 url이 되는 것이다. 이것을 시크릿 키와 함께 오픈비두에 요청을 보내고 싶은 서버의 설정 파일에 설정하면 된다.
    
- Spring Batch 배포 매뉴얼
    
    jar 파일 생성 후 ec2에 전송
    
    Dockerfile 작성
    
    ```json
    # 베이스 이미지 설정
    FROM openjdk:21-jdk-slim
    
    # 작업 디렉토리 설정
    WORKDIR /app
    
    # JAR 파일 복사
    COPY lingoland-batch-0.0.1-SNAPSHOT.jar /app/lingoland-batch.jar
    
    # 애플리케이션 실행
    ENTRYPOINT ["java", "-jar", "/app/lingoland-batch.jar"]
    
    ```
    
    docker-compose.yml 작성
    
    ```json
    version: '3.8'
    services:
      lingoland-batch:
        container_name: lingoland-batch
        build: .
        ports:
          - "8081:8081"
        environment:
          - SPRING_PROFILES_ACTIVE=prod
          - POSTGRES_URL=jdbc:postgresql://postgres:5432/lingoland
          - CHAT_GPT_KEY=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
          - EXECUTION_CNT=1000
        restart: always
        networks:
          - backend-network
    networks:
      backend-network:
        external: true
    
    ```
    
- 프론트엔드, 백엔드 배포
    
    docker-compose.yml 작성
    
    ```json
    version: '3.8'
    
    services:
      **lingoland-backend:
        container_name: lingoland-backend
        build: ./lingoland-backend
        environment:
    
          - SPRING_PROFILES_ACTIVE=prod
          - JWT_SECRET=64461f01e1af406da538b9c48d801ce59142452199ff112fb5404c8e7e98e3ff
          - KAKAO_REST_KEY=315689ddc97372cef0cd9ac818125f76
          - DEEPL_API_KEY=4c8aae49-32ef-47c9-8710-a3026bc3e89c:fx
    
          - FRONTEND_URL=https://i11a603.p.ssafy.io:443
    
          - REDIS_HOST=redis
          - REDIS_PORT=6379
          - LOG_LEVEL_ROOT=debug
          - OPENVIDU_URL=https://i11a603.p.ssafy.io:8843
          - OPENVIDU_SECRET=ssafy
    
          - POSTGRES_URL=jdbc:postgresql://postgres:5432/lingoland
          - POSTGRES_USERNAME=postgres
          - POSTGRES_PASSWORD=ssafy
    
          - OLLAMA_URL=http://i11a603.p.ssafy.io/api/generate
          - IMAGE_PATH=http://i11a603.p.ssafy.io/api/images/
          - STORE_PATH=/home/ubuntu/image-store
          - CHAT_GPT_KEY=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
        image: docker-image/backend
        ports:
          - '8080:8080'
    
        networks:
          - backend-network
        restart: on-failure
    
      lingoland-frontend:
        user: root
        container_name: lingoland-frontend
        build:
          context: ./lingoland-frontend
          dockerfile: Dockerfile
        image: docker-image/frontend
        depends_on:
          - lingoland-backend
    #      - openvidu
        environment:
          - VITE_SERVER_URL=https://i11a603.p.ssafy.io/api/v1
          - VITE_SERVER_IMAGE_URL=http://i11a603.p.ssafy.io/api/images
        ports:
          - '80:80'
          - '443:443'
        networks:
          - backend-network
        volumes:
          - type: bind
            source: /etc/letsencrypt
            target: /etc/letsencrypt
        restart: always
    
    networks:
      backend-network:
        external: true**
                          
                         
    ```
    
    젠킨스 웹훅, 스케줄링으로 자동 빌드, 배포 및 알림 사용
    
    스케줄러
    
    ```json
    TZ=Asia/Seoul
    H */3 * * *
    ```
    
    script
    
    ```json
    pipeline {
        agent any
        
        tools {
            nodejs 'nodejs'
        }
        
        environment {
            //DOCKERHUB_ID = credentials('ssafytkddbs1644')
            LINGOLAND_FRONTEND_IMAGE = 'frontend'
            LINGOLAND_BACKEND_IMAGE = 'backend'
        }
        
        stages {
            stage ('GitLab Repository Checkout') {
                steps {
                    git branch: 'develop',
                        credentialsId: 'junhyuk1027@naver.com',
                        url: 'https://lab.ssafy.com/s11-webmobile1-sub2/S11P12A603.git'
                }
            }
    
            
            stage('Backend Build') {
                steps {
                    script {
                        echo '********** Backend Build Start **********'
                        dir('lingoland-backend') {
                            sh 'docker build -t docker-image/$LINGOLAND_BACKEND_IMAGE .'
                        }
                        
                        echo '********** Backend Build End **********'
                    }
                }
            }
            
            stage('Frontend Build') {
                steps {
                    script {
                        echo '********** Frontend Build Start **********'
                        dir('lingoland-frontend') {
                            sh 'docker build -t docker-image/$LINGOLAND_FRONTEND_IMAGE .'
                        }
                        
                        echo '********** Frontend Build End **********'
                    }
                }
            }
            
            stage('Docker Compose Up'){
                steps {
                    script{
                        echo '******** Docker Compose Start ************'
                        sh 'docker compose down'
                        sh 'docker compose up -d'
                        
                        echo '********** Docker Compose End ***********'
                    }
                }
            }
                  
            stage('Delete unnecessary Docker images') {
                steps {
                    script {
                        echo '********** Delete unnecessary Docker images Start **********'
                        
                        sh 'docker image prune -a -f'
                        
                        echo '********** Delete unnecessary Docker images End **********'
                    }
                }
            }
        }
        post {
            success {
            	script {
                    def Author_ID = sh(script: "git show -s --pretty=%an", returnStdout: true).trim()
                    def Author_Name = sh(script: "git show -s --pretty=%ae", returnStdout: true).trim()
                    mattermostSend (color: 'good', 
                    message: "빌드 성공: ${env.JOB_NAME} #${env.BUILD_NUMBER} by ${Author_ID}(${Author_Name})\n(<${env.BUILD_URL}|Details>)", 
                    endpoint: 'https://meeting.ssafy.com/hooks/hkgw5f7k33rgircyir4wjob4qe', 
                    channel: 'jenkins'
                    )
                }
            }
            failure {
            	script {
                    def Author_ID = sh(script: "git show -s --pretty=%an", returnStdout: true).trim()
                    def Author_Name = sh(script: "git show -s --pretty=%ae", returnStdout: true).trim()
                    mattermostSend (color: 'danger', 
                    message: "빌드 실패: ${env.JOB_NAME} #${env.BUILD_NUMBER} by ${Author_ID}(${Author_Name})\n(<${env.BUILD_URL}|Details>)", 
                    endpoint: 'https://meeting.ssafy.com/hooks/hkgw5f7k33rgircyir4wjob4qe', 
                    channel: 'jenkins'
                    )
                }
            }
        }
    
    }
    ```
    
    도커 파일은 각 프로젝트 내에 포함되어 있음
    
- 데이터베이스
    
    ### postgresql 배포
    
    docker-compose-postgres.yml 작성
    
    ```json
    version: '3.8'
    
    services:
      postgres:
        image: postgres:latest
        container_name: postgres
        environment:
          POSTGRES_DB: lingoland
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: ssafy
        ports:
          - "5432:5432"
        volumes:
          - postgres-data:/var/lib/postgresql/data
        networks:
          - backend-network
        restart: always
    
    networks:
      backend-network:
        external: true
    
    volumes:
      postgres-data:
          driver: local
    
                                            
    ```
    

docker-compose up -d -f docker-compose-postgres.yml으로 실행

## Redis

```json
version: '3.8'

services:
  redis:
    image: redis:latest
    container_name: redis
    ports:
      - "6379:6379"
    volumes:
      - redisdata:/data
    networks:
      - backend-network
    restart: always

networks:
  backend-network:
    external: true

volumes:
  redisdata:
    driver: local

```